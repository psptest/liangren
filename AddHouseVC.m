////  AddHouseVC.m//  security////  Created by sen5labs on 15/9/30.//  Copyright © 2015年 sen5. All rights reserved.//#import "AddHouseVC.h"#import "UIViewController+MBProgressHUD.h"#import "QRCodeView.h"#import "NSString+Check.h"#import "HouseModelHandle.h"#import "HouseModel.h"#import "UIView+MBProgressHUD.h"#import "SetHomeViewController.h"#import "Des3Handle.h"#import "prefrenceHeader.h"#import <AudioToolbox/AudioToolbox.h>@interface AddHouseVC (){    NSString *_did;}@property (nonatomic, strong) QRCodeView            * qrCodeView;          // 扫描动画@end@implementation AddHouseVC- (void)viewDidLoad {    [super viewDidLoad];        [self setupUI];    }- (void)setupUI {        [self addBackBtn:NSLocalizedString(@"Add_New_Home", nil])];      [self.view addSubview:self.qrCodeView];        [self.qrCodeView setRecommands:NSLocalizedString(@"Scan_QRCode", nil)];    __weak typeof(self) weakSelf = self;        [self.qrCodeView startReadingWithCompletBlock:^(id obj) {                //成功回调        [weakSelf.qrCodeView stopReading];        weakSelf.qrCodeView.hidden = YES;                // 扫描到了字符串        [weakSelf updateWithSuccess:[weakSelf checkQRString:obj]];        MYLog(@"the string is %@",obj);    }];        //  [self updateWithSuccess:[self checkQRString:@"JMfWglcvnHCW5T8ZB9mivvaR08dKj3HW"]];    }-(void )pushSettingViewController{        // 震动    AudioServicesPlaySystemSound(kSystemSoundID_Vibrate);        HouseModel *mod = [[HouseModel alloc ]init];    mod.name = [NSString stringWithFormat:@"%@  %d",NSLocalizedString(@"House", nil),[[HouseModelHandle shareHouseHandle] houses].count];    mod.address = _did;        SetHomeViewController *setHome = [[SetHomeViewController alloc ]initWithHome:mod];        [self.navigationController pushViewController:setHome animated:NO];}#pragma mark - 判断字符串- (BOOL)checkQRString:(NSString *)des3String {        // 字符串是3des 加密的  需要解密    NSString * textString = [Des3Handle TripleDES:des3String encryptOrDecrypt:kCCDecrypt];    if (textString.length > 6) {        // 解密出来的是一个 长度大于6的字符串  要去掉后六位 就是我们所需要的did        NSString * did = [textString substringToIndex:textString.length - 6];        _did = did;        if (did && ![did isEqualToString:@""]) {            //判断address是否存在 如果存在 显示hourse is exist            if ([[HouseModelHandle shareHouseHandle] isExistHouseWithAdress:did]) {                                //连接成功 显示Hub                [self showWithTime:hubAnimationTime title:NSLocalizedString(@"House_Existed", nil)];                return NO;                            } else {                                //如果没有 则添加                [[HouseModelHandle shareHouseHandle] addWithAddress:did];                return YES;            }        } else {                     [self showWithTime:hubAnimationTime title:NSLocalizedString(@"Something_Wrong_QR", nil)];            return NO;        }    } else {               [self showWithTime:hubAnimationTime title:NSLocalizedString(@"Something_Wrong_QR", nil)];    }        return NO;}//更新UI- (void)updateWithSuccess:(BOOL)success {     if (success){               // [self showWithTime:hubAnimationTime title:NSLocalizedString(@"House_Added", nil)];             //   dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(hubAnimationTime * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{                        //            //弹出控制器//            [self.navigationController popViewControllerAnimated:YES];//            //            [_delegate AddHouseComplished];                        [self pushSettingViewController];                            //    });    } else {                      dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(hubAnimationTime * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{            //弹出控制器            [self.navigationController popViewControllerAnimated:YES];        });    }    }- (QRCodeView *)qrCodeView {    if (!_qrCodeView) {        _qrCodeView = [[QRCodeView alloc] initWithFrame:self.view.bounds];    }    return _qrCodeView;}@end