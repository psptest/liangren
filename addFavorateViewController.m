////  addFavorateViewController.m//  security2.0////  Created by Sen5 on 16/6/29.//  Copyright © 2016年 com.letianxia. All rights reserved.//#import "addFavorateViewController.h"#import "prefrenceHeader.h"#import "fileOperation.h"#import "simulatorOperation.h"#import "HouseModelHandle.h"#import "MBProgressHUD.h"#import "UIViewController+MBProgressHUD.h"#import "P2Phandle.h"#import "DeviceModel.h"#import "SvUDIDTools.h"#import "selectCell.h"@interface addFavorateViewController ()<selectCellDelegate>@property(nonatomic,strong)MBProgressHUD *hubView;@end@implementation addFavorateViewController{    NSMutableArray *_dataList;    NSMutableArray *_favorates;}- (instancetype)initWithFavorates:(NSArray *)favorates{    self = [super init];    if (self) {        _favorates = [NSMutableArray arrayWithArray:favorates];        _dataList = [NSMutableArray array];    }    return self;}- (void)viewDidLoad {        [super viewDidLoad];         [self.navigationController.navigationBar setHidden:NO];        self.navigationItem.rightBarButtonItem = [[UIBarButtonItem alloc] initWithTitle:NSLocalizedString(@"Done", nil) style:UIBarButtonItemStyleDone target:self action:@selector(selectionHaveDone)];        [self addBackBtn:NSLocalizedString(@"Add_Favorat_Device", nil)];        //获取控制设备    NSMutableArray *mut = [NSMutableArray arrayWithArray:[[fileOperation sharedOperation] getControls]];        if (_favorates.count != 0) {                for (DeviceModel *dev in _favorates){                        for (DeviceModel *devi in [mut copy]) {                if (dev.dev_id == devi.dev_id) {                    [mut removeObject:devi];                }            }                    }         [_dataList addObjectsFromArray:_favorates];        [_dataList addObjectsFromArray:mut];    }else    {        _dataList = mut;    }            [self.tableView registerClass:[selectCell class] forCellReuseIdentifier:@"reuse"];    self.tableView.tableFooterView = [[UIView alloc] init];        [[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(favorateDeviceSetted:) name:kNotification_favorateSetted object:nil];   }-(void )dealloc{    [[NSNotificationCenter defaultCenter] removeObserver:self];    }- (void)didReceiveMemoryWarning {    [super didReceiveMemoryWarning];    }#pragma mark - Table view data source- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView {    return 1;}- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {    return [_dataList count] ;}- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {        selectCell *cell = [tableView dequeueReusableCellWithIdentifier:@"reuse"];    if (cell == nil) {        cell = [[selectCell alloc] initWithStyle:UITableViewCellStyleDefault reuseIdentifier:@"reuse"];    }        cell.delegate = self;        DeviceModel *mod = _dataList[indexPath.row];    //设置内容    NSDictionary *dic = [[fileOperation sharedOperation] getImageNameWithDevice_type:mod.dev_type device_mode:1];        if ([mod.status[0][@"params"] isEqualToString:@"AQ=="]) {        [cell setImage:dic[@"on"]];    }else    {       [cell setImage:dic[@"off"]];    }        [cell setText:mod.name];      if (mod.isFavorate) {        [cell setSeleted:YES];    }else    {        [cell setSeleted:NO];    }        return cell;}-(CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath{    return 100;}- (MBProgressHUD *)hubView {    if (!_hubView) {                if (self.view.window) {            MBProgressHUD * HUD = [[MBProgressHUD alloc] initWithView:self.view.window];            [self.view.window addSubview:HUD];            [HUD hide:YES];            _hubView = HUD;        }    }    return _hubView;}-(void)haveSeletedCell:(selectCell *)cell{     NSIndexPath *index = [self.tableView indexPathForCell:cell];    DeviceModel *device = _dataList[index.row];        if ([cell getSeleted]) {                [cell setSeleted:NO];        device.isFavorate = NO;    }else    {        [cell setSeleted:YES];        device.isFavorate = YES;    }}-(void)selectionHaveDone{    NSMutableArray *favorates = [NSMutableArray array];        for (NSInteger i =0; i<_dataList.count; i++) {        DeviceModel *dev = _dataList[i];        if (dev.isFavorate) {            [favorates addObject:@(dev.dev_id)];        }    }    //设置常用设备    NSString *UUID = [NSString stringWithFormat:@"%@",[SvUDIDTools UDID]];    if ([[P2Phandle shareP2PHandle] linkState] != P2PLinkConnnected) {        [self showWithTime:hubAnimationTime title:kConnectedFailed];    }else    {        [self.hubView show:YES];        [self.hubView hide:YES afterDelay:HubViewDelayTime];        [[P2Phandle shareP2PHandle] setFavorateDevicesWithUUID:UUID dev_list:favorates];    }        }-(void )favorateDeviceSetted:(NSNotification  *)notice{        [self.hubView hide:YES];        NSDictionary *diction = notice.object;    NSArray *array = diction[@"dev_list"];       [_delegate haveSeletedFavorateDevices:array];        [self.navigationController popViewControllerAnimated:YES];}@end